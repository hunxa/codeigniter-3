name: CodeIgniter 3 CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  validate:
    name: Code Validation & Quality Checks
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: 7.4
        extensions: mbstring, intl, mysqli, gd, zip, curl, xml

    - name: PHP Syntax Check
      run: |
        echo "ğŸ” Checking PHP syntax..."
        find application/ -name "*.php" -print0 | xargs -0 -n1 php -l
        echo "âœ“ PHP syntax check passed"

    - name: Verify CodeIgniter Structure
      run: |
        echo "ğŸ” Verifying CodeIgniter directory structure..."
        
        # Check core directories
        if [ ! -d "application" ]; then
          echo "âŒ application directory not found"
          exit 1
        fi
        
        if [ ! -d "system" ]; then
          echo "âŒ system directory not found"
          exit 1
        fi
        
        if [ ! -f "index.php" ]; then
          echo "âŒ index.php not found"
          exit 1
        fi
        
        # Check application subdirectories
        required_dirs=("controllers" "models" "views" "config")
        for dir in "${required_dirs[@]}"; do
          if [ ! -d "application/$dir" ]; then
            echo "âŒ application/$dir directory not found"
            exit 1
          fi
        done
        
        echo "âœ“ CodeIgniter structure validated"

    - name: Check Required Config Files
      run: |
        echo "ğŸ” Checking required configuration files..."
        
        if [ ! -f "application/config/config.php" ]; then
          echo "âŒ config.php not found"
          exit 1
        fi
        
        if [ ! -f "application/config/database.php" ]; then
          echo "âŒ database.php not found"
          exit 1
        fi
        
        if [ ! -f "application/config/routes.php" ]; then
          echo "âŒ routes.php not found"
          exit 1
        fi
        
        if [ ! -f "application/config/autoload.php" ]; then
          echo "âŒ autoload.php not found"
          exit 1
        fi
        
        if [ ! -f "application/config/constants.php" ]; then
          echo "âŒ constants.php not found"
          exit 1
        fi
        
        echo "âœ“ All required config files present"

    - name: Validate PHP Configuration Files
      run: |
        echo "ğŸ” Validating config file syntax..."
        
        config_files=$(find application/config -name "*.php")
        for file in $config_files; do
          php -l "$file" > /dev/null || {
            echo "âŒ Syntax error in $file"
            exit 1
          }
        done
        
        echo "âœ“ Config files syntax validated"

    - name: Check Controllers Syntax
      run: |
        echo "ğŸ” Checking controllers..."
        
        if [ -d "application/controllers" ]; then
          controller_files=$(find application/controllers -name "*.php")
          for file in $controller_files; do
            php -l "$file" > /dev/null || {
              echo "âŒ Syntax error in $file"
              exit 1
            }
          done
          echo "âœ“ Controllers validated"
        fi

    - name: Check Models Syntax
      run: |
        echo "ğŸ” Checking models..."
        
        if [ -d "application/models" ]; then
          model_files=$(find application/models -name "*.php")
          if [ -n "$model_files" ]; then
            for file in $model_files; do
              php -l "$file" > /dev/null || {
                echo "âŒ Syntax error in $file"
                exit 1
              }
            done
          fi
          echo "âœ“ Models validated"
        fi

    - name: Check Libraries Syntax
      run: |
        echo "ğŸ” Checking libraries..."
        
        if [ -d "application/libraries" ]; then
          library_files=$(find application/libraries -name "*.php")
          if [ -n "$library_files" ]; then
            for file in $library_files; do
              php -l "$file" > /dev/null || {
                echo "âŒ Syntax error in $file"
                exit 1
              }
            done
          fi
          echo "âœ“ Libraries validated"
        fi

    - name: Check Helpers Syntax
      run: |
        echo "ğŸ” Checking helpers..."
        
        if [ -d "application/helpers" ]; then
          helper_files=$(find application/helpers -name "*.php")
          if [ -n "$helper_files" ]; then
            for file in $helper_files; do
              php -l "$file" > /dev/null || {
                echo "âŒ Syntax error in $file"
                exit 1
              }
            done
          fi
          echo "âœ“ Helpers validated"
        fi

    - name: Security Checks
      run: |
        echo "ğŸ”’ Running security checks..."
        
        # Check for exposed sensitive files
        if [ -f "assets/config.php" ] || [ -f "public/config.php" ]; then
          echo "âŒ Config file found in public directory!"
          exit 1
        fi
        
        # Check for .env files that shouldn't be committed
        if [ -f ".env" ] && grep -q "DB_PASSWORD" .env 2>/dev/null; then
          echo "âš ï¸  .env file with credentials found in repository"
        fi
        
        # Check for debug mode in production config
        if grep -q "['\"]\s*log_threshold['\"]\s*.*=>\s*4" application/config/config.php 2>/dev/null; then
          echo "âš ï¸  Debug mode (log_threshold = 4) detected in config"
        fi
        
        # Check for hardcoded credentials
        if grep -rn "password.*=.*['\"][^'\"]\{3,\}['\"]" application/config/database.php 2>/dev/null | grep -v "''" | grep -v '""'; then
          echo "âš ï¸  Possible hardcoded database password detected"
        fi
        
        # Check for index.php in routes
        if grep -q "['\"]\s*index_page['\"]\s*.*=>\s*['\"]index\.php['\"]" application/config/config.php 2>/dev/null; then
          echo "âš ï¸  index.php still in URL (consider removing for cleaner URLs)"
        fi
        
        echo "âœ“ Security checks completed"

    - name: Check File Permissions Requirements
      run: |
        echo "ğŸ” Checking writable directories..."
        
        # Check if writable directories exist
        writable_dirs=("application/cache" "application/logs")
        
        for dir in "${writable_dirs[@]}"; do
          if [ -d "$dir" ]; then
            echo "âœ“ $dir exists"
            
            # Check if .htaccess exists for protection
            if [ ! -f "$dir/.htaccess" ]; then
              echo "âš ï¸  $dir/.htaccess not found (should deny access)"
            fi
          else
            echo "âš ï¸  $dir not found (may cause issues)"
          fi
        done

    - name: Check for Common Issues
      run: |
        echo "ğŸ” Checking for common CodeIgniter issues..."
        
        # Check for short PHP tags
        if grep -rn "<?" application/ --include="*.php" | grep -v "<?php" | grep -v "<?="; then
          echo "âš ï¸  Short PHP tags found (may cause issues on some servers)"
        fi
        
        # Check for trailing whitespace in controllers (can cause header issues)
        if grep -rn "?>\s*$" application/controllers/ --include="*.php" 2>/dev/null; then
          echo "âš ï¸  Trailing whitespace after ?> found in controllers"
        fi
        
        # Check for BOM in files
        if grep -rl $'\xEF\xBB\xBF' application/ --include="*.php" 2>/dev/null; then
          echo "âš ï¸  BOM (Byte Order Mark) found in PHP files"
        fi
        
        echo "âœ“ Common issues check completed"

    - name: Code Quality Report
      if: always()
      run: |
        echo "ğŸ“Š Generating code quality report..."
        
        # Count files
        controllers=$(find application/controllers -name "*.php" 2>/dev/null | wc -l)
        models=$(find application/models -name "*.php" 2>/dev/null | wc -l)
        views=$(find application/views -name "*.php" 2>/dev/null | wc -l)
        libraries=$(find application/libraries -name "*.php" 2>/dev/null | wc -l)
        helpers=$(find application/helpers -name "*.php" 2>/dev/null | wc -l)
        
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“ˆ Code Quality Report"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Controllers: $controllers"
        echo "Models: $models"
        echo "Views: $views"
        echo "Libraries: $libraries"
        echo "Helpers: $helpers"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Total PHP files: $((controllers + models + views + libraries + helpers))"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    - name: Success Summary
      if: success()
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âœ… All Checks Passed!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Commit: ${{ github.sha }}"
        echo "Branch: ${{ github.ref }}"
        echo "Author: ${{ github.actor }}"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"